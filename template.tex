\documentclass[dvipdfmx,a4paper,openany]{jsbook}
\usepackage[includeheadfoot,top=20truemm,bottom=20truemm, right=25truemm,left=25truemm]{geometry} % 余白を調製

\usepackage{amsmath,amssymb}
\usepackage{bm}
\usepackage{ascmac}
\usepackage{okumacro}
\usepackage{epigraph}

\setlength{\epigraphwidth}{0.6\textwidth}

\usepackage[dvipdfmx]{color}
\usepackage[dvipdfmx]{graphicx}
% \usepackage[draft]{graphicx} %コンパイルが遅い時はこれで枠だけにすると速くできる

\usepackage{longtable} % 表組みに必要
\usepackage{booktabs,array} % 表組みに必要
\usepackage{subfig} % 図の横並びに必要
\usepackage{ulem} % 取り消し線に必要
\usepackage{url}
\usepackage{otf}

\usepackage[font={sf,small}]{caption}

\usepackage[backend=biber,backref=true,date=year,style=authoryear]{biblatex-japanese}
% 引用にnodateを許す
\renewbibmacro*{date}{%
  \iffieldundef{year}
    {\bibstring{nodate}}
    {\printdate}}
% % 日本語文献の引用形式を普通にするためのマクロ。日本語文献はlanguage=japaneseを指定しておくこと
% \newbibmacro*{finalnamedelim:{japanese}}{%
%   \ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
%   \addspace\multinamedelim
% }

% \renewcommand*{\finalnamedelim}{%
%   \iflistundef{language}
%   {\ifnumgreater{\value{liststop}}{2}{\finalandcomma}{}%
%   \addspace\bibstring{and}\space}
%   {\usebibmacro*{finalnamedelim:\strlist{language}}}
% }

% \newbibmacro*{name:given-family:{japanese}}[4]{%
%   \usebibmacro{name:delim}{#1#2}\usebibmacro{name:hook}{#1#2}#1\bibnamedelimc#2}

% \DeclareNameFormat{given-family}{%
%   \iflistundef{language}{%
%     \ifgiveninits
%       {\usebibmacro{name:given-family}{\namepartfamily}{\namepartgiveni}{\namepartprefix}{\namepartsuffix}}
%       {\usebibmacro{name:given-family}{\namepartfamily}{\namepartgiven}{\namepartprefix}{\namepartsuffix}}
%   }
%   {\usebibmacro*{name:given-family:\strlist{language}}{\namepartfamily}{\namepartgiven}{\namepartprefix}{\namepartsuffix}}
%   \usebibmacro{name:andothers}
% }
% % 


\usepackage{xcolor}
\usepackage{fvextra}


\usepackage{framed}
\usepackage[dvipdfmx]{hyperref}
\usepackage{pxjahyper} % ハイパーリンクに日本語が含まれる場合に必要
\hypersetup{% hyperrefのオプションリスト
    colorlinks=true,% カラーリンクを使用
    linkcolor=black,% 内部参照リンクの色
    citecolor=black,% 文献参照リンクの色
    filecolor=black,% ローカルファイル参照リンクの色
    urlcolor=blue % 外部参照URLの色
}

% 画像を記述された場所に挿入(デフォルトではページ上部に挿入されてしまう)
\usepackage{float}
\let\origfigure\figure
\let\endorigfigure\endfigure
\renewenvironment{figure}[1][2] {
    \expandafter\origfigure\expandafter[H]
} {
    \endorigfigure
}

% 画像の縦横比を保ったままサイズ変更を可能にする
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

\def\tightlist{\itemsep1pt\parskip0pt\parsep0pt} % これがないと\tightlistが動かない

% ハイライトの設定、Rustのトークナイズあんまりうまく行ってない？

\newenvironment{Shaded}{\begin{shaded}}{\end{shaded}}
\definecolor{shadecolor}{RGB}{240,240,240}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}
  {breaklines,breakanywhere,commandchars=\\\{\}}

\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}

\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
\newcommand{\RegionMarkerTok}[1]{{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\NormalTok}[1]{{#1}}
\newcommand{\PreprocessorTok}[1]{\ImportTok{{#1}}}


% listingsでhighlightする時の設定一応残しとく
\usepackage{listings,listings-rust}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.1,0.1,0.8}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.98,0.98,0.98}
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=true,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,        
    xleftmargin=1em,
    xrightmargin=0.6em,
    framexleftmargin=0.7em,       
    numbersep=2pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=mystyle}

\renewcommand{\lstlistingname}{コード}

\providecommand{\citep}{\parencite}
\renewcommand{\emph}[1]{\textgt{\textit{#1}}}

\providecommand{\mimium}{\textit{mimium}}

\addbibresource{./ref.bib}

% カスタムタイトルを作る
\makeatletter
\renewcommand*{\maketitle}{%
\begin{titlepage}
    \let\footnotesize\small
    \let\footnoterule\relax
    \let\footnote\thanks
    \null\vfil
    \vskip 60\jsc@mpt
    \begin{center}%
      {\LARGE \@title \par}%
      \vskip 24em%
      {\large
        \lineskip .75em
        \begin{tabular}[t]{c}%
          \@author
        \end{tabular}\par}%
      \vskip 1.5em
      {\large \@date \par}%
    \end{center}%
    \par
    \@thanks\vfil\null
\end{titlepage}
}
\makeatother

\title{音楽土木工学を設計する―\\音楽のためのプログラミング言語\mimium{}の開発を通じて\\
\vskip 1.5em
\Large{Designing Civil Engineering of Music\\ through the development of \mimium{}, a programming language for music}
}
\author{松浦 知也 \\
        \normalsize{Matsuura Tomoya}}
\date{2022年3月}

\begin{document}

\frontmatter

\maketitle


\addcontentsline{toc}{chapter}{概要}
\begin{abstract}
\chapter*{概要}
    \input{abstract}
\chapter*{Abstract}
    \input{abstract_en}
\end{abstract}

\setcounter{tocdepth}{3}
\tableofcontents

\addcontentsline{toc}{chapter}{用語集}
\chapter*{用語集}
\input{glossary}

\addcontentsline{toc}{chapter}{図目次}
\listoffigures
\renewcommand\lstlistlistingname{コード例目次}
\addcontentsline{toc}{chapter}{コード例目次}
\lstlistoflistings

\mainmatter

\chapter{序論}
\input{chapter1}

\chapter{歴史を記述しなおすデザインリサーチ}
\input{chapter2}

\chapter{Why:PLfMをなぜ研究するか}
\input{chapter3}

\chapter{What1:PLfMの歴史}
\input{chapter4}

\chapter{What2:PLfMにおける諸用語と概念の整理}
\input{chapter5}

\chapter{最小限のPLfM:mimiumの設計と実装}
\input{chapter6}

\chapter{議論}
\input{chapter7}

\chapter{結論:音楽土木工学に向けて}
\input{chapter8}

\addcontentsline{toc}{chapter}{参考文献}
\printbibliography[title = 参考文献]

\addcontentsline{toc}{chapter}{謝辞}
\chapter*{謝辞}
\input{acknowledgement}

\end{document}